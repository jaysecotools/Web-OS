<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebOS v2.0 - Enhanced Complete Version</title>
    <style>
        /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* ===== DESKTOP ===== */
        .desktop {
            height: 100vh;
            padding: 40px 20px 70px 20px;
            position: relative;
            background-image: 
                radial-gradient(circle at 15% 25%, rgba(120, 119, 198, 0.15) 0%, transparent 25%),
                radial-gradient(circle at 85% 75%, rgba(255, 119, 198, 0.1) 0%, transparent 25%);
        }

        .desktop-icons {
            display: grid;
            grid-template-columns: repeat(auto-fill, 90px);
            gap: 25px;
            padding: 20px;
            max-width: 700px;
        }

        .icon {
            text-align: center;
            cursor: pointer;
            padding: 15px 10px;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 90px;
            backdrop-filter: blur(5px);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .icon:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .icon:active {
            transform: translateY(-4px) scale(1.02);
        }

        .icon img {
            width: 48px;
            height: 48px;
            margin-bottom: 10px;
            filter: drop-shadow(0 6px 8px rgba(0, 0, 0, 0.4));
        }

        .icon span {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.95);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            line-height: 1.3;
        }

        /* ===== TASKBAR ===== */
        .taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: rgba(20, 20, 35, 0.98);
            backdrop-filter: blur(20px) saturate(180%);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            padding: 0 25px;
            z-index: 10000;
            box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.4);
        }

        .start-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 25px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            margin-right: 25px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .start-btn:active {
            transform: translateY(0);
        }

        .taskbar-apps {
            display: flex;
            gap: 12px;
            flex: 1;
        }

        .taskbar-app {
            background: rgba(255, 255, 255, 0.08);
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid transparent;
        }

        .taskbar-app:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .taskbar-app.active {
            background: rgba(102, 126, 234, 0.25);
            border-color: rgba(102, 126, 234, 0.4);
        }

        .system-tray {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: auto;
        }

        .tray-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
            position: relative;
        }

        .tray-icon:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tray-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #ff4757;
            color: white;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
        }

        .clock {
            color: #a0a0ff;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: 500;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* ===== WINDOWS ===== */
        .window {
            position: absolute;
            background: rgba(28, 28, 44, 0.97);
            backdrop-filter: blur(30px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            min-width: 500px;
            min-height: 350px;
            display: none;
            z-index: 1000;
            overflow: hidden;
            resize: both;
        }

        .window.active {
            display: flex;
            flex-direction: column;
        }

        .window-header {
            background: linear-gradient(135deg, rgba(40, 40, 60, 0.95), rgba(30, 30, 50, 0.95));
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: move;
            user-select: none;
            flex-shrink: 0;
        }

        .window-title {
            font-weight: 600;
            color: #a0a0ff;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .window-controls {
            display: flex;
            gap: 12px;
        }

        .window-btn {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .window-btn:hover {
            transform: scale(1.1);
        }

        .window-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            color: rgba(0, 0, 0, 0.7);
            font-weight: bold;
        }

        .close {
            background: #ff5f57;
        }

        .minimize {
            background: #ffbd2e;
        }

        .maximize {
            background: #28ca42;
        }

        .window-content {
            padding: 25px;
            flex: 1;
            overflow: auto;
            background: rgba(20, 20, 35, 0.7);
        }

        /* ===== FILE EXPLORER ===== */
        .file-explorer {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .explorer-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .toolbar-btn {
            background: rgba(255, 255, 255, 0.08);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.3s;
        }

        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .explorer-path {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 20px;
            flex: 1;
        }

        .file-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px 15px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .file-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-5px);
            border-color: rgba(102, 126, 234, 0.3);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .file-icon {
            font-size: 36px;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.3));
        }

        .file-name {
            font-size: 13px;
            font-weight: 500;
            word-break: break-word;
            max-width: 100%;
        }

        .file-size {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 2px;
        }

        /* ===== WEB BROWSER ===== */
        .browser-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .browser-toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-buttons {
            display: flex;
            gap: 8px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.08);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .url-container {
            flex: 1;
            display: flex;
            gap: 10px;
            min-width: 300px;
        }

        .url-bar {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 20px;
            color: white;
            font-size: 14px;
            transition: all 0.3s;
        }

        .url-bar:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .go-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 25px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .go-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .browser-frame-container {
            flex: 1;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: white;
            position: relative;
        }

        .browser-frame {
            width: 100%;
            height: 100%;
            border: none;
        }

        .browser-status {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 15px;
            font-size: 12px;
            display: none;
        }

        /* ===== WINAMP PLAYER ===== */
        .winamp-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .winamp-player {
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            border: 3px solid #333;
            border-radius: 8px;
            font-family: 'Tahoma', 'Arial', sans-serif;
            color: #ccc;
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .winamp-titlebar {
            background: linear-gradient(to right, #000066, #330066);
            color: #00ff00;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid #444;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 5px #00ff00;
        }

        .winamp-controls {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .winamp-display {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            padding: 10px 15px;
            border-radius: 4px;
            border: 2px solid #333;
            min-height: 50px;
            display: flex;
            align-items: center;
            font-size: 14px;
            text-shadow: 0 0 10px #0f0;
            letter-spacing: 1px;
        }

        .winamp-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin: 10px 0;
        }

        .winamp-button {
            background: linear-gradient(to bottom, #444, #222);
            border: 2px outset #666;
            border-radius: 4px;
            color: #ccc;
            padding: 10px 5px;
            font-size: 11px;
            text-align: center;
            cursor: pointer;
            transition: all 0.1s;
            text-transform: uppercase;
            font-weight: bold;
        }

        .winamp-button:hover {
            background: linear-gradient(to bottom, #555, #333);
            border-color: #777;
            color: #fff;
        }

        .winamp-button:active {
            border-style: inset;
            transform: translateY(1px);
        }

        .winamp-button.active {
            background: linear-gradient(to bottom, #006600, #003300);
            color: #0f0;
            border-color: #00aa00;
        }

        .playback-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
        }

        .time-display {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #0f0;
            min-width: 100px;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: #222;
            border-radius: 4px;
            border: 1px solid #444;
            overflow: hidden;
            cursor: pointer;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #00aa00, #00ff00);
            width: 0%;
            transition: width 0.1s;
        }

        .volume-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .volume-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: #222;
            border-radius: 3px;
            border: 1px solid #444;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #0f0;
            cursor: pointer;
            border: 2px solid #000;
        }

        .winamp-playlist {
            background: #111;
            border-radius: 4px;
            border: 2px inset #333;
            max-height: 200px;
            overflow-y: auto;
            flex: 1;
        }

        .playlist-item {
            padding: 8px 12px;
            border-bottom: 1px solid #222;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .playlist-item:hover {
            background: #222;
        }

        .playlist-item.playing {
            background: #003300;
            color: #0f0;
            border-left: 3px solid #0f0;
        }

        .track-duration {
            color: #888;
            font-size: 11px;
            font-family: monospace;
        }

        .visualizer {
            height: 40px;
            background: #000;
            border-radius: 4px;
            border: 2px inset #333;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            padding: 5px;
            margin-top: 10px;
        }

        .v-bar {
            width: 4px;
            background: #0f0;
            border-radius: 2px;
            transition: height 0.05s;
            box-shadow: 0 0 5px #0f0;
        }

        /* ===== TERMINAL ===== */
        .terminal-container {
            height: 100%;
            background: #1e1e1e;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            font-family: 'JetBrains Mono', 'Cascadia Code', monospace;
        }

        .terminal-header {
            background: #2d2d2d;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
        }

        .terminal-title {
            color: #00ff00;
            font-size: 14px;
            font-weight: 600;
        }

        .terminal-controls {
            display: flex;
            gap: 10px;
        }

        .terminal-btn {
            background: #444;
            border: none;
            color: #ccc;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .terminal-btn:hover {
            background: #555;
        }

        .terminal-output {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            color: #ccc;
            font-size: 14px;
            line-height: 1.5;
        }

        .terminal-line {
            margin-bottom: 5px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .command-line {
            color: #00ff00;
        }

        .terminal-input {
            background: transparent;
            border: none;
            border-top: 1px solid #444;
            padding: 15px 20px;
            color: #00ff00;
            font-family: inherit;
            font-size: 14px;
            width: 100%;
            outline: none;
        }

        .terminal-input::placeholder {
            color: #666;
        }

        /* ===== START MENU ===== */
        .start-menu {
            position: fixed;
            bottom: 80px;
            left: 25px;
            width: 350px;
            background: rgba(30, 30, 50, 0.98);
            backdrop-filter: blur(40px);
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6);
            display: none;
            z-index: 10001;
            overflow: hidden;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .start-menu.active {
            display: block;
        }

        .start-menu-header {
            padding: 25px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9));
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fff, #ddd);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: #667eea;
            font-weight: bold;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .user-details h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .user-details p {
            font-size: 13px;
            opacity: 0.9;
        }

        .start-menu-sections {
            display: flex;
            height: 400px;
        }

        .start-menu-left {
            width: 60%;
            padding: 20px;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
        }

        .start-menu-right {
            width: 40%;
            padding: 20px;
            background: rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .menu-section {
            margin-bottom: 25px;
        }

        .menu-section h4 {
            color: #a0a0ff;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid transparent;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .menu-item-icon {
            font-size: 20px;
            width: 30px;
            text-align: center;
        }

        .menu-item-text h5 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .menu-item-text p {
            font-size: 12px;
            opacity: 0.7;
        }

        .power-options {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .power-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid rgba(255, 71, 87, 0.3);
            border-radius: 10px;
            color: #ff4757;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .power-btn:hover {
            background: rgba(255, 71, 87, 0.2);
            transform: translateY(-2px);
        }

        /* ===== NOTIFICATIONS ===== */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 350px;
            z-index: 20000;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .notification {
            background: rgba(30, 30, 50, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 14px;
            padding: 20px;
            border-left: 5px solid #667eea;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            animation: slideInRight 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform-origin: right;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%) scale(0.8); opacity: 0; }
            to { transform: translateX(0) scale(1); opacity: 1; }
        }

        .notification.hiding {
            animation: slideOutRight 0.5s ease forwards;
        }

        @keyframes slideOutRight {
            to { transform: translateX(100%) scale(0.8); opacity: 0; }
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .notification-title {
            font-weight: 600;
            color: #a0a0ff;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            font-size: 18px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .notification-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .notification-body {
            font-size: 14px;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.9);
        }

        .notification-progress {
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 15px;
            overflow: hidden;
        }

        .notification-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 100%;
            animation: progressShrink 5s linear forwards;
        }

        @keyframes progressShrink {
            from { width: 100%; }
            to { width: 0%; }
        }

        /* ===== ENHANCED FEATURES ===== */
        .external-url-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 100000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .external-url-content {
            background: rgba(30, 30, 50, 0.95);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            border: 1px solid rgba(102, 126, 234, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .external-url-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .external-url-btn {
            flex: 1;
            padding: 15px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 120px;
        }

        .external-url-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .external-url-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .external-url-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .audio-permission {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            z-index: 1000;
            border-radius: 8px;
            text-align: center;
        }

        .compatibility-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }

        .compatibility-good {
            background: rgba(40, 200, 40, 0.2);
            color: #28c828;
            border: 1px solid rgba(40, 200, 40, 0.3);
        }

        .compatibility-warning {
            background: rgba(255, 200, 40, 0.2);
            color: #ffc828;
            border: 1px solid rgba(255, 200, 40, 0.3);
        }

        .compatibility-bad {
            background: rgba(255, 70, 70, 0.2);
            color: #ff4646;
            border: 1px solid rgba(255, 70, 70, 0.3);
        }

        .proxy-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 100;
        }

        .proxy-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .local-files {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .local-file {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .local-file:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-3px);
        }

        .quick-launch {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(20, 20, 35, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 5000;
        }

        .quick-launch-btn {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-launch-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.1);
        }

        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }

        .dragging {
            opacity: 0.8;
            cursor: move !important;
        }

        .resizing {
            cursor: nwse-resize !important;
        }

        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: loadingShimmer 1.5s infinite;
        }

        @keyframes loadingShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* ===== SCROLLBAR STYLING ===== */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid transparent;
            background-clip: content-box;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .desktop-icons {
                grid-template-columns: repeat(auto-fill, 80px);
                gap: 15px;
            }
            
            .window {
                min-width: 90vw;
                min-height: 70vh;
                left: 5vw !important;
                top: 5vh !important;
            }
            
            .start-menu {
                width: 90vw;
                left: 5vw;
            }
            
            .start-menu-sections {
                flex-direction: column;
                height: auto;
            }
            
            .start-menu-left,
            .start-menu-right {
                width: 100%;
                border: none;
            }
            
            .quick-launch {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- DESKTOP WITH ICONS -->
    <div class="desktop" id="desktop">
        <div class="desktop-icons">
            <div class="icon" onclick="openApp('files')" title="File Explorer">
                <div class="file-icon">üìÅ</div>
                <span>File Explorer</span>
            </div>
            <div class="icon" onclick="openApp('browser')" title="Web Browser">
                <div class="file-icon">üåê</div>
                <span>Web Browser</span>
            </div>
            <div class="icon" onclick="openApp('winamp')" title="Winamp Player">
                <div class="file-icon">üéµ</div>
                <span>Winamp Player</span>
            </div>
            <div class="icon" onclick="openApp('terminal')" title="Terminal">
                <div class="file-icon">üíª</div>
                <span>Terminal</span>
            </div>
            <div class="icon" onclick="showNotification('System', 'Settings app coming soon!')" title="Settings">
                <div class="file-icon">‚öôÔ∏è</div>
                <span>Settings</span>
            </div>
            <div class="icon" onclick="openApp('notepad')" title="Notepad">
                <div class="file-icon">üìù</div>
                <span>Notepad</span>
            </div>
        </div>
    </div>

    <!-- FILE EXPLORER WINDOW -->
    <div class="window" id="files-window" style="top: 100px; left: 100px; width: 700px; height: 500px;">
        <div class="window-header" onmousedown="startDrag(event, 'files')">
            <div class="window-title">
                <span>üìÅ</span>
                File Explorer <span class="compatibility-badge compatibility-good">Enhanced</span>
            </div>
            <div class="window-controls">
                <div class="window-btn minimize" onclick="minimizeWindow('files')"></div>
                <div class="window-btn maximize" onclick="toggleMaximize('files')"></div>
                <div class="window-btn close" onclick="closeWindow('files')"></div>
            </div>
        </div>
        <div class="window-content">
            <div class="file-explorer">
                <div class="explorer-toolbar">
                    <button class="toolbar-btn" onclick="enhancedFileExplorer.goBack()">
                        ‚Üê Back
                    </button>
                    <button class="toolbar-btn" onclick="enhancedFileExplorer.goForward()">
                        ‚Üí Forward
                    </button>
                    <button class="toolbar-btn" onclick="enhancedFileExplorer.goUp()">
                        ‚Üë Up
                    </button>
                    <button class="toolbar-btn" onclick="enhancedFileExplorer.refresh()">
                        ‚Üª Refresh
                    </button>
                    <button class="toolbar-btn" onclick="enhancedFileExplorer.createFolder()">
                        + New Folder
                    </button>
                    <button class="toolbar-btn" onclick="enhancedFileExplorer.createNewFile()">
                        + New File
                    </button>
                </div>
                <div class="explorer-path" id="current-path">
                    C:\Users\WebOS\Desktop
                </div>
                <div class="files-grid" id="files-grid">
                    <!-- Files will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- WEB BROWSER WINDOW -->
    <div class="window" id="browser-window" style="top: 150px; left: 250px; width: 900px; height: 600px;">
        <div class="window-header" onmousedown="startDrag(event, 'browser')">
            <div class="window-title">
                <span>üåê</span>
                Web Browser <span class="compatibility-badge compatibility-good">Enhanced</span>
            </div>
            <div class="window-controls">
                <div class="window-btn minimize" onclick="minimizeWindow('browser')"></div>
                <div class="window-btn maximize" onclick="toggleMaximize('browser')"></div>
                <div class="window-btn close" onclick="closeWindow('browser')"></div>
            </div>
        </div>
        <div class="window-content">
            <div class="browser-container">
                <div class="browser-toolbar">
                    <div class="nav-buttons">
                        <button class="nav-btn" onclick="enhancedBrowser.goBack()" id="back-btn" title="Back">‚Üê</button>
                        <button class="nav-btn" onclick="enhancedBrowser.goForward()" id="forward-btn" title="Forward">‚Üí</button>
                        <button class="nav-btn" onclick="enhancedBrowser.refresh()" title="Refresh">‚Üª</button>
                        <button class="nav-btn" onclick="enhancedBrowser.goHome()" title="Home">‚åÇ</button>
                    </div>
                    <div class="url-container">
                        <input type="text" class="url-bar" id="url-bar" 
                               value="https://lite.duckduckgo.com/lite/"
                               placeholder="Enter URL or search..."
                               onkeydown="if(event.key === 'Enter') enhancedBrowser.goToUrl()">
                        <button class="go-btn" onclick="enhancedBrowser.goToUrl()">Go</button>
                    </div>
                </div>
                <div class="browser-frame-container">
                    <iframe class="browser-frame" id="browser-frame" 
                            src="https://lite.duckduckgo.com/lite/">
                    </iframe>
                    <div class="browser-status" id="browser-status"></div>
                </div>
                <div style="margin-top: 15px; font-size: 12px; color: #888; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    üí° <strong>Tip:</strong> For best compatibility, use "lite" versions of sites. Try: 
                    <button onclick="enhancedBrowser.loadUrl('https://lite.duckduckgo.com/lite/')" style="background: none; border: 1px solid #667eea; color: #667eea; padding: 3px 8px; border-radius: 4px; margin: 0 5px; cursor: pointer;">DuckDuckGo Lite</button>
                    <button onclick="enhancedBrowser.loadUrl('https://en.m.wikipedia.org')" style="background: none; border: 1px solid #667eea; color: #667eea; padding: 3px 8px; border-radius: 4px; margin: 0 5px; cursor: pointer;">Wikipedia Mobile</button>
                    <button onclick="enhancedBrowser.loadUrl('https://old.reddit.com')" style="background: none; border: 1px solid #667eea; color: #667eea; padding: 3px 8px; border-radius: 4px; margin: 0 5px; cursor: pointer;">Old Reddit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- WINAMP PLAYER WINDOW -->
    <div class="window" id="winamp-window" style="top: 200px; left: 400px; width: 400px; height: 550px;">
        <div class="window-header" onmousedown="startDrag(event, 'winamp')">
            <div class="window-title">
                <span>üéµ</span>
                Winamp 2.95 <span class="compatibility-badge compatibility-good">Enhanced</span>
            </div>
            <div class="window-controls">
                <div class="window-btn minimize" onclick="minimizeWindow('winamp')"></div>
                <div class="window-btn maximize" onclick="toggleMaximize('winamp')"></div>
                <div class="window-btn close" onclick="closeWindow('winamp')"></div>
            </div>
        </div>
        <div class="window-content">
            <div class="winamp-container">
                <div class="winamp-player">
                    <div class="winamp-titlebar">
                        <span>Winamp 2.95</span>
                        <span id="winamp-time">00:00</span>
                    </div>
                    <div class="winamp-controls">
                        <div class="winamp-display" id="winamp-display">
                            WebOS Radio - Ready
                        </div>
                        
                        <div class="winamp-buttons">
                            <div class="winamp-button" onclick="enhancedWinamp.previousTrack()" title="Previous Track">‚óÄ‚óÄ</div>
                            <div class="winamp-button" onclick="enhancedWinamp.togglePlay()" id="play-btn" title="Play/Pause">‚ñ∂</div>
                            <div class="winamp-button" onclick="enhancedWinamp.stop()" title="Stop">‚ñ†</div>
                            <div class="winamp-button" onclick="enhancedWinamp.nextTrack()" title="Next Track">‚ñ∂‚ñ∂</div>
                            <div class="winamp-button" onclick="enhancedWinamp.toggleMute()" id="mute-btn" title="Mute">üîä</div>
                        </div>
                        
                        <div class="playback-controls">
                            <div class="time-display" id="current-time">00:00</div>
                            <div class="progress-bar" onclick="enhancedWinamp.seek(event)" id="progress-bar">
                                <div class="progress-fill" id="progress-fill"></div>
                            </div>
                            <div class="time-display" id="total-time">00:00</div>
                        </div>
                        
                        <div class="volume-controls">
                            <span style="font-size: 12px;">Vol:</span>
                            <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="70" 
                                   oninput="enhancedWinamp.setVolume(this.value)">
                            <span style="font-size: 12px; min-width: 30px;" id="volume-text">70%</span>
                        </div>
                        
                        <div class="visualizer" id="visualizer">
                            <!-- Visualizer bars generated by JS -->
                        </div>
                        
                        <div class="winamp-playlist" id="winamp-playlist">
                            <!-- Playlist generated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TERMINAL WINDOW -->
    <div class="window" id="terminal-window" style="top: 250px; left: 500px; width: 600px; height: 400px;">
        <div class="window-header" onmousedown="startDrag(event, 'terminal')">
            <div class="window-title">
                <span>üíª</span>
                Terminal <span class="compatibility-badge compatibility-good">Enhanced</span>
            </div>
            <div class="window-controls">
                <div class="window-btn minimize" onclick="minimizeWindow('terminal')"></div>
                <div class="window-btn maximize" onclick="toggleMaximize('terminal')"></div>
                <div class="window-btn close" onclick="closeWindow('terminal')"></div>
            </div>
        </div>
        <div class="window-content">
            <div class="terminal-container">
                <div class="terminal-header">
                    <div class="terminal-title">WebOS Terminal v2.0</div>
                    <div class="terminal-controls">
                        <button class="terminal-btn" onclick="terminal.clear()">Clear</button>
                        <button class="terminal-btn" onclick="terminal.copyOutput()">Copy</button>
                        <button class="terminal-btn" onclick="terminal.reset()">Reset</button>
                    </div>
                </div>
                <div class="terminal-output" id="terminal-output">
                    <!-- Terminal output will be here -->
                </div>
                <input type="text" class="terminal-input" id="terminal-input" 
                       placeholder="Type 'help' for available commands..."
                       onkeydown="terminal.handleInput(event)">
            </div>
        </div>
    </div>

    <!-- TASKBAR -->
    <div class="taskbar">
        <button class="start-btn" onclick="toggleStartMenu()">
            <span>üåÄ</span>
            START
        </button>
        
        <div class="taskbar-apps" id="taskbar-apps">
            <!-- Taskbar apps will be added here -->
        </div>
        
        <div class="system-tray">
            <div class="tray-icon" onclick="showNotification('Wi-Fi', 'Connected to WebOS Network')" title="Wi-Fi">
                üì∂
            </div>
            <div class="tray-icon" onclick="showNotification('Volume', 'Click to adjust volume')" title="Volume">
                üîä
                <div class="tray-badge" id="volume-badge">70</div>
            </div>
            <div class="tray-icon" onclick="showNotification('Storage', 'Local storage is active')" title="Storage">
                üíæ
            </div>
            <div class="clock" id="clock">--:--:--</div>
        </div>
    </div>

    <!-- START MENU -->
    <div class="start-menu" id="start-menu">
        <div class="start-menu-header">
            <div class="user-info">
                <div class="user-avatar">W</div>
                <div class="user-details">
                    <h3>WebOS User</h3>
                    <p>v2.0 Enhanced</p>
                </div>
            </div>
        </div>
        <div class="start-menu-sections">
            <div class="start-menu-left">
                <div class="menu-section">
                    <h4>Applications</h4>
                    <div class="menu-items">
                        <div class="menu-item" onclick="openApp('files')">
                            <div class="menu-item-icon">üìÅ</div>
                            <div class="menu-item-text">
                                <h5>File Explorer</h5>
                                <p>Browse your files</p>
                            </div>
                        </div>
                        <div class="menu-item" onclick="openApp('browser')">
                            <div class="menu-item-icon">üåê</div>
                            <div class="menu-item-text">
                                <h5>Web Browser</h5>
                                <p>Browse the internet</p>
                            </div>
                        </div>
                        <div class="menu-item" onclick="openApp('winamp')">
                            <div class="menu-item-icon">üéµ</div>
                            <div class="menu-item-text">
                                <h5>Winamp Player</h5>
                                <p>Play music & audio</p>
                            </div>
                        </div>
                        <div class="menu-item" onclick="openApp('terminal')">
                            <div class="menu-item-icon">üíª</div>
                            <div class="menu-item-text">
                                <h5>Terminal</h5>
                                <p>Command line interface</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="menu-section">
                    <h4>Documents</h4>
                    <div class="menu-items">
                        <div class="menu-item" onclick="enhancedFileExplorer.showLocalFiles(); openApp('files');">
                            <div class="menu-item-icon">üìù</div>
                            <div class="menu-item-text">
                                <h5>Local Files</h5>
                                <p>Edit and save files</p>
                            </div>
                        </div>
                        <div class="menu-item" onclick="showNotification('Projects', 'Opening Projects folder...')">
                            <div class="menu-item-icon">üìÅ</div>
                            <div class="menu-item-text">
                                <h5>WebOS Projects</h5>
                                <p>Contains 3 items</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="start-menu-right">
                <div class="menu-section">
                    <h4>System</h4>
                    <div class="menu-items">
                        <div class="menu-item" onclick="showNotification('Settings', 'Opening System Settings...')">
                            <div class="menu-item-icon">‚öôÔ∏è</div>
                            <div class="menu-item-text">
                                <h5>Settings</h5>
                                <p>System configuration</p>
                            </div>
                        </div>
                        <div class="menu-item" onclick="showNotification('Help', 'Opening Help Center...')">
                            <div class="menu-item-icon">‚ùì</div>
                            <div class="menu-item-text">
                                <h5>Help & Support</h5>
                                <p>Get help with WebOS</p>
                            </div>
                        </div>
                        <div class="menu-item" onclick="showNotification('Updates', 'Checking for updates...')">
                            <div class="menu-item-icon">üîÑ</div>
                            <div class="menu-item-text">
                                <h5>Check for Updates</h5>
                                <p>WebOS v2.0</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="power-options">
                    <div class="menu-item" onclick="storageManager.exportOS()">
                        <div class="menu-item-icon">üíæ</div>
                        <div class="menu-item-text">
                            <h5>Export Backup</h5>
                            <p>Save your WebOS state</p>
                        </div>
                    </div>
                    <div class="power-btn" onclick="enhancedShutdown()">
                        <span>‚èª</span>
                        Shut Down
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION CONTAINER -->
    <div class="notification-container" id="notification-container">
        <!-- Notifications will be added here dynamically -->
    </div>

    <!-- HIDDEN AUDIO ELEMENT -->
    <audio id="audio-player" crossorigin="anonymous"></audio>

    <script>
        // ===== GLOBAL STATE =====
        const WebOS = {
            version: '2.0.0',
            apps: {},
            settings: {
                theme: 'dark',
                volume: 70,
                notifications: true
            },
            data: {
                files: [],
                bookmarks: [],
                history: []
            }
        };

        // ===== NOTIFICATION SYSTEM =====
        class NotificationSystem {
            constructor() {
                this.container = document.getElementById('notification-container');
                this.notifications = new Set();
            }

            show(title, message, duration = 5000, type = 'info') {
                const id = 'notif-' + Date.now() + Math.random();
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.id = id;
                
                const icons = {
                    info: '‚ÑπÔ∏è',
                    success: '‚úÖ',
                    warning: '‚ö†Ô∏è',
                    error: '‚ùå',
                    winamp: 'üéµ',
                    browser: 'üåê',
                    system: '‚öôÔ∏è'
                };
                
                const icon = icons[type] || icons.info;
                
                notification.innerHTML = `
                    <div class="notification-header">
                        <div class="notification-title">
                            <span>${icon}</span>
                            ${title}
                        </div>
                        <button class="notification-close" onclick="notificationSystem.close('${id}')">√ó</button>
                    </div>
                    <div class="notification-body">${message}</div>
                    <div class="notification-progress">
                        <div class="notification-progress-bar"></div>
                    </div>
                `;
                
                this.container.appendChild(notification);
                this.notifications.add(id);
                
                // Auto-close after duration
                setTimeout(() => this.close(id), duration);
                
                return id;
            }

            close(id) {
                const notification = document.getElementById(id);
                if (notification) {
                    notification.classList.add('hiding');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                        this.notifications.delete(id);
                    }, 500);
                }
            }

            clearAll() {
                this.notifications.forEach(id => this.close(id));
            }
        }

        const notificationSystem = new NotificationSystem();

        function showNotification(title, message, duration = 3000, type = 'info') {
            return notificationSystem.show(title, message, duration, type);
        }

        // ===== WINDOW MANAGEMENT =====
        class WindowManager {
            constructor() {
                this.windows = {};
                this.zIndex = 1000;
                this.dragging = null;
                this.resizing = null;
                this.offset = { x: 0, y: 0 };
                this.minimizedApps = new Set();
                this.maximizedApps = new Set();
            }

            registerApp(appName, element) {
                this.windows[appName] = {
                    element: element,
                    minimized: false,
                    maximized: false,
                    position: { x: 100, y: 100 },
                    size: { width: 600, height: 400 }
                };
                
                // Add to taskbar
                this.addToTaskbar(appName);
            }

            addToTaskbar(appName) {
                const taskbar = document.getElementById('taskbar-apps');
                const app = document.createElement('div');
                app.className = 'taskbar-app';
                app.innerHTML = `<span>${this.getAppIcon(appName)}</span> ${appName}`;
                app.onclick = () => this.toggleApp(appName);
                taskbar.appendChild(app);
                
                // Store reference
                this.windows[appName].taskbarElement = app;
            }

            getAppIcon(appName) {
                const icons = {
                    'files': 'üìÅ',
                    'browser': 'üåê',
                    'winamp': 'üéµ',
                    'terminal': 'üíª',
                    'notepad': 'üìù'
                };
                return icons[appName] || 'üìÑ';
            }

            openApp(appName) {
                const window = this.windows[appName];
                if (!window) return;
                
                const element = document.getElementById(`${appName}-window`);
                if (!element) return;
                
                // Remove minimized state
                this.minimizedApps.delete(appName);
                window.minimized = false;
                
                // Bring to front
                this.bringToFront(appName);
                
                // Show window
                element.classList.add('active');
                
                // Update taskbar
                if (window.taskbarElement) {
                    window.taskbarElement.classList.add('active');
                }
                
                // Initialize app if needed
                this.initializeApp(appName);
                
                showNotification('WebOS', `${appName} launched`, 2000, 'system');
            }

            initializeApp(appName) {
                switch(appName) {
                    case 'files':
                        enhancedFileExplorer.loadFiles();
                        break;
                    case 'browser':
                        enhancedBrowser.initialize();
                        break;
                    case 'winamp':
                        enhancedWinamp.initialize();
                        break;
                    case 'terminal':
                        terminal.initialize();
                        break;
                }
            }

            closeWindow(appName) {
                const window = this.windows[appName];
                if (!window) return;
                
                const element = document.getElementById(`${appName}-window`);
                if (element) {
                    element.classList.remove('active');
                }
                
                // Update taskbar
                if (window.taskbarElement) {
                    window.taskbarElement.classList.remove('active');
                }
                
                // Clean up
                switch(appName) {
                    case 'winamp':
                        enhancedWinamp.stop();
                        break;
                }
                
                showNotification('WebOS', `${appName} closed`, 2000, 'system');
            }

            minimizeWindow(appName) {
                const window = this.windows[appName];
                if (!window) return;
                
                const element = document.getElementById(`${appName}-window`);
                if (element) {
                    element.classList.remove('active');
                }
                
                window.minimized = true;
                this.minimizedApps.add(appName);
                
                // Update taskbar
                if (window.taskbarElement) {
                    window.taskbarElement.classList.add('active');
                }
            }

            toggleMaximize(appName) {
                const window = this.windows[appName];
                if (!window) return;
                
                const element = document.getElementById(`${appName}-window`);
                if (!element) return;
                
                if (window.maximized) {
                    // Restore
                    element.style.width = window.size.width + 'px';
                    element.style.height = window.size.height + 'px';
                    element.style.top = window.position.y + 'px';
                    element.style.left = window.position.x + 'px';
                    window.maximized = false;
                    this.maximizedApps.delete(appName);
                } else {
                    // Maximize
                    window.size = {
                        width: element.offsetWidth,
                        height: element.offsetHeight
                    };
                    window.position = {
                        x: parseInt(element.style.left) || 100,
                        y: parseInt(element.style.top) || 100
                    };
                    
                    element.style.width = '90vw';
                    element.style.height = '80vh';
                    element.style.top = '5vh';
                    element.style.left = '5vw';
                    window.maximized = true;
                    this.maximizedApps.add(appName);
                }
            }

            toggleApp(appName) {
                const window = this.windows[appName];
                if (!window) return;
                
                const element = document.getElementById(`${appName}-window`);
                if (!element) return;
                
                if (window.minimized || !element.classList.contains('active')) {
                    this.openApp(appName);
                } else {
                    this.minimizeWindow(appName);
                }
            }

            bringToFront(appName) {
                const element = document.getElementById(`${appName}-window`);
                if (element) {
                    this.zIndex++;
                    element.style.zIndex = this.zIndex;
                }
            }

            startDrag(event, appName) {
                if (event.target.closest('.window-controls')) return;
                
                const element = document.getElementById(`${appName}-window`);
                if (!element) return;
                
                this.dragging = {
                    element: element,
                    appName: appName,
                    startX: event.clientX,
                    startY: event.clientY,
                    startLeft: parseInt(element.style.left) || 100,
                    startTop: parseInt(element.style.top) || 100
                };
                
                element.classList.add('dragging');
                this.bringToFront(appName);
                
                event.preventDefault();
            }

            handleDrag(event) {
                if (!this.dragging) return;
                
                const dx = event.clientX - this.dragging.startX;
                const dy = event.clientY - this.dragging.startY;
                
                const newLeft = this.dragging.startLeft + dx;
                const newTop = this.dragging.startTop + dy;
                
                this.dragging.element.style.left = Math.max(0, newLeft) + 'px';
                this.dragging.element.style.top = Math.max(0, newTop) + 'px';
            }

            stopDrag() {
                if (this.dragging) {
                    this.dragging.element.classList.remove('dragging');
                    this.dragging = null;
                }
            }
        }

        const windowManager = new WindowManager();

        // ===== ENHANCED FILE EXPLORER =====
        class EnhancedFileExplorer {
            constructor() {
                this.currentPath = 'C:\\Users\\WebOS\\Desktop';
                this.history = [];
                this.historyIndex = -1;
                this.files = [
                    { name: 'Documents', type: 'folder', size: '2.4 MB', icon: 'üìÅ', modified: '2024-01-15' },
                    { name: 'Pictures', type: 'folder', size: '15.7 MB', icon: 'üñºÔ∏è', modified: '2024-01-14' },
                    { name: 'Music', type: 'folder', size: '89.3 MB', icon: 'üéµ', modified: '2024-01-13' },
                    { name: 'Downloads', type: 'folder', size: '3.2 MB', icon: 'üì•', modified: '2024-01-15' },
                    { name: 'notes.txt', type: 'file', size: '4.2 KB', icon: 'üìù', modified: '2024-01-15' },
                    { name: 'todo.html', type: 'file', size: '12.8 KB', icon: 'üìÑ', modified: '2024-01-14' },
                    { name: 'screenshot.png', type: 'file', size: '1.2 MB', icon: 'üñºÔ∏è', modified: '2024-01-13' },
                    { name: 'presentation.ppt', type: 'file', size: '3.4 MB', icon: 'üìä', modified: '2024-01-12' },
                    { name: 'budget.xlsx', type: 'file', size: '256 KB', icon: 'üìà', modified: '2024-01-11' },
                    { name: 'readme.md', type: 'file', size: '2.1 KB', icon: 'üìã', modified: '2024-01-10' }
                ];
                this.localFiles = [];
                this.loadLocalFiles();
            }

            loadLocalFiles() {
                try {
                    const saved = localStorage.getItem('webos_local_files');
                    this.localFiles = saved ? JSON.parse(saved) : [
                        { 
                            name: 'Welcome.txt', 
                            content: 'Welcome to WebOS v2.0!\n\nThis is your local storage. Files saved here will persist between sessions.\n\nYou can edit this file and it will be saved automatically.', 
                            type: 'text', 
                            size: '1.2 KB',
                            created: new Date().toISOString(),
                            modified: new Date().toISOString()
                        },
                        { 
                            name: 'Notes.md', 
                            content: '# My WebOS Notes\n\n## Features:\n- Enhanced browser with external URL handling\n- Winamp with audio permission fixes\n- Local file storage\n- Auto-save settings\n- Quick launch toolbar\n\n## Tips:\n1. Right-click for context menus\n2. Drag windows to move\n3. Use Quick Launch for fast access', 
                            type: 'markdown', 
                            size: '0.8 KB',
                            created: new Date().toISOString(),
                            modified: new Date().toISOString()
                        }
                    ];
                } catch (e) {
                    this.localFiles = [];
                }
            }

            saveLocalFiles() {
                try {
                    localStorage.setItem('webos_local_files', JSON.stringify(this.localFiles));
                } catch (e) {
                    console.error('Failed to save local files:', e);
                }
            }

            loadFiles() {
                const grid = document.getElementById('files-grid');
                const pathElement = document.getElementById('current-path');
                
                if (!grid) return;
                
                grid.innerHTML = '';
                pathElement.textContent = this.currentPath;
                
                // Add local files section
                const localSection = document.createElement('div');
                localSection.style.gridColumn = '1 / -1';
                localSection.style.marginBottom = '20px';
                localSection.innerHTML = `
                    <h4 style="color: #a0a0ff; margin-bottom: 15px; display: flex; align-items: center;">
                        üìÅ Local Files (Saved)
                        <button onclick="enhancedFileExplorer.createNewFile()" 
                                style="margin-left: auto; background: rgba(102,126,234,0.2); 
                                       border: 1px solid rgba(102,126,234,0.4); color: #667eea; 
                                       padding: 5px 15px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                            + New File
                        </button>
                    </h4>
                `;
                grid.appendChild(localSection);
                
                // Display local files
                this.localFiles.forEach((file, index) => {
                    const fileElement = document.createElement('div');
                    fileElement.className = 'file-item';
                    fileElement.innerHTML = `
                        <div class="file-icon">${this.getFileIcon(file.type)}</div>
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${file.size}</div>
                    `;
                    
                    fileElement.onclick = () => this.openLocalFile(index);
                    grid.appendChild(fileElement);
                });
                
                // Add separator
                const separator = document.createElement('div');
                separator.style.gridColumn = '1 / -1';
                separator.style.margin = '20px 0';
                separator.style.borderTop = '1px solid rgba(255,255,255,0.1)';
                grid.appendChild(separator);
                
                // Display regular files
                this.files.forEach(file => {
                    const fileElement = document.createElement('div');
                    fileElement.className = 'file-item';
                    fileElement.innerHTML = `
                        <div class="file-icon">${file.icon}</div>
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${file.type} ‚Ä¢ ${file.size}</div>
                    `;
                    
                    fileElement.onclick = () => {
                        if (file.type === 'folder') {
                            this.openFolder(file.name);
                        } else {
                            this.openFile(file);
                        }
                    };
                    
                    fileElement.ondblclick = () => {
                        if (file.type === 'folder') {
                            this.openFolder(file.name);
                        }
                    };
                    
                    grid.appendChild(fileElement);
                });
            }

            openFolder(folderName) {
                this.history.push(this.currentPath);
                this.historyIndex++;
                this.currentPath += '\\' + folderName;
                this.loadFiles();
                showNotification('File Explorer', `Opened folder: ${folderName}`, 2000, 'info');
            }

            openFile(file) {
                showNotification('File Explorer', `Opening: ${file.name}`, 2000, 'info');
                
                switch(file.name.split('.').pop()) {
                    case 'txt':
                    case 'md':
                        this.createLocalFile(file.name, `Content of ${file.name}\n\nThis is a simulated file.`, 'text');
                        break;
                    case 'html':
                        enhancedBrowser.loadUrl(`data:text/html,<h1>${file.name}</h1><p>Simulated HTML file</p>`);
                        windowManager.openApp('browser');
                        break;
                    default:
                        showNotification('File Explorer', `No application configured for .${file.name.split('.').pop()} files`, 3000, 'warning');
                }
            }

            openLocalFile(index) {
                const file = this.localFiles[index];
                
                const editor = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                                background: rgba(0,0,0,0.9); z-index: 100000; 
                                display: flex; justify-content: center; align-items: center;">
                        <div style="background: rgba(30,30,50,0.95); border-radius: 15px; 
                                    padding: 30px; width: 80%; max-width: 800px; max-height: 80vh;
                                    display: flex; flex-direction: column;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="color: #a0a0ff;">${file.name}</h3>
                                <button onclick="this.closest('div').remove()" 
                                        style="background: #ff4757; color: white; border: none; 
                                               width: 30px; height: 30px; border-radius: 50%; cursor: pointer;">√ó</button>
                            </div>
                            <textarea id="file-editor-${index}" 
                                      style="flex: 1; background: rgba(0,0,0,0.5); color: white; 
                                             border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;
                                             padding: 15px; font-family: 'JetBrains Mono', monospace; 
                                             font-size: 14px; resize: none;"
                                      rows="20">${file.content}</textarea>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button onclick="enhancedFileExplorer.saveLocalFile(${index})" 
                                        style="flex: 1; background: linear-gradient(135deg, #667eea, #764ba2); 
                                               border: none; padding: 12px; border-radius: 8px; color: white; cursor: pointer;">
                                    üíæ Save
                                </button>
                                <button onclick="this.closest('div').remove()" 
                                        style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); 
                                               padding: 12px 24px; border-radius: 8px; color: white; cursor: pointer;">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', editor);
            }

            saveLocalFile(index) {
                const editor = document.getElementById(`file-editor-${index}`);
                if (editor) {
                    this.localFiles[index].content = editor.value;
                    this.localFiles[index].modified = new Date().toISOString();
                    this.localFiles[index].size = this.formatSize(editor.value.length);
                    this.saveLocalFiles();
                    
                    showNotification('File Explorer', `Saved: ${this.localFiles[index].name}`, 2000, 'success');
                    
                    // Close editor
                    editor.closest('div').remove();
                }
            }

            createNewFile() {
                const name = prompt('Enter file name (with extension):', 'newfile.txt');
                if (name) {
                    const type = this.getFileType(name);
                    const content = `# ${name}\n\nCreated on ${new Date().toLocaleString()}\n\nStart typing here...`;
                    this.createLocalFile(name, content, type);
                    this.loadFiles();
                }
            }

            createLocalFile(name, content, type = 'text') {
                this.localFiles.push({
                    name,
                    content,
                    type,
                    size: this.formatSize(content.length),
                    created: new Date().toISOString(),
                    modified: new Date().toISOString()
                });
                
                this.saveLocalFiles();
                showNotification('File Explorer', `Created: ${name}`, 2000, 'success');
            }

            formatSize(bytes) {
                if (bytes < 1024) return bytes + ' bytes';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            }

            getFileIcon(type) {
                const icons = {
                    'text': 'üìù',
                    'markdown': 'üìÑ',
                    'html': 'üåê',
                    'json': 'üìã'
                };
                return icons[type] || 'üìÑ';
            }

            getFileType(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                const types = {
                    'txt': 'text',
                    'md': 'markdown',
                    'html': 'html',
                    'json': 'json'
                };
                return types[ext] || 'text';
            }

            goBack() {
                if (this.historyIndex > 0) {
                    this.historyIndex--;
                    this.currentPath = this.history[this.historyIndex];
                    this.loadFiles();
                }
            }

            goForward() {
                if (this.historyIndex < this.history.length - 1) {
                    this.historyIndex++;
                    this.currentPath = this.history[this.historyIndex];
                    this.loadFiles();
                }
            }

            goUp() {
                const parts = this.currentPath.split('\\');
                if (parts.length > 3) {
                    parts.pop();
                    this.currentPath = parts.join('\\');
                    this.loadFiles();
                }
            }

            refresh() {
                this.loadFiles();
                showNotification('File Explorer', 'Refreshed', 1000, 'info');
            }

            createFolder() {
                const folderName = prompt('Enter folder name:', 'New Folder');
                if (folderName && folderName.trim()) {
                    this.files.unshift({
                        name: folderName.trim(),
                        type: 'folder',
                        size: '0 bytes',
                        icon: 'üìÅ',
                        modified: new Date().toISOString().split('T')[0]
                    });
                    this.loadFiles();
                    showNotification('File Explorer', `Created folder: ${folderName}`, 2000, 'success');
                }
            }

            showLocalFiles() {
                this.loadFiles();
            }
        }

        const enhancedFileExplorer = new EnhancedFileExplorer();

        // ===== ENHANCED WEB BROWSER =====
        class EnhancedBrowser {
            constructor() {
                this.history = [];
                this.currentIndex = -1;
                this.homePage = 'https://lite.duckduckgo.com/lite/';
                this.isLoading = false;
                this.compatibleSites = [
                    'lite.duckduckgo.com',
                    'en.m.wikipedia.org',
                    'old.reddit.com',
                    'textise.iitty',
                    'wiby.me',
                    'mbasic.facebook.com',
                    'mobile.twitter.com'
                ];
                
                this.iframeBlockedSites = [
                    'youtube.com',
                    'google.com',
                    'facebook.com',
                    'twitter.com',
                    'deepseek.com',
                    'netflix.com',
                    'instagram.com'
                ];
            }

            initialize() {
                const frame = document.getElementById('browser-frame');
                const urlBar = document.getElementById('url-bar');
                
                if (!frame) return;
                
                frame.onload = () => {
                    this.isLoading = false;
                    this.updateNavButtons();
                    showNotification('Browser', 'Page loaded successfully', 1500, 'browser');
                };
                
                frame.onerror = () => {
                    this.isLoading = false;
                    showNotification('Browser Error', 'Failed to load page. Site may block iframes.', 3000, 'error');
                };
                
                // Load home page if not already loaded
                if (frame.src !== this.homePage && !frame.src) {
                    this.loadUrl(this.homePage);
                }
                
                this.updateNavButtons();
            }

            async loadUrl(url) {
                const frame = document.getElementById('browser-frame');
                const urlBar = document.getElementById('url-bar');
                
                if (!frame || !urlBar) return;
                
                let finalUrl = url.trim();
                
                // Add protocol if missing
                if (!finalUrl.match(/^https?:\/\//)) {
                    if (finalUrl.includes(' ') || !finalUrl.includes('.')) {
                        finalUrl = `https://lite.duckduckgo.com/lite/?q=${encodeURIComponent(finalUrl)}`;
                    } else {
                        finalUrl = 'https://' + finalUrl;
                    }
                }
                
                urlBar.value = finalUrl;
                
                // Check if site is compatible
                if (this.isSiteCompatible(finalUrl)) {
                    // Show loading indicator
                    this.showLoadingIndicator();
                    
                    try {
                        frame.src = finalUrl;
                        this.isLoading = true;
                        
                        // Add to history
                        if (this.history[this.currentIndex] !== finalUrl) {
                            this.history = this.history.slice(0, this.currentIndex + 1);
                            this.history.push(finalUrl);
                            this.currentIndex++;
                        }
                        
                        showNotification('Browser', `Loading: ${new URL(finalUrl).hostname}`, 2000, 'browser');
                    } catch (error) {
                        console.warn('Direct load failed:', error);
                        this.handleExternalUrl(finalUrl);
                    }
                } else {
                    // Show options for incompatible site
                    this.handleExternalUrl(finalUrl);
                }
                
                this.updateNavButtons();
            }

            isSiteCompatible(url) {
                try {
                    const hostname = new URL(url).hostname;
                    
                    // Check if site is in blocked list
                    if (this.iframeBlockedSites.some(site => hostname.includes(site))) {
                        return false;
                    }
                    
                    // Check if site is in compatible list
                    if (this.compatibleSites.some(site => hostname.includes(site))) {
                        return true;
                    }
                    
                    // For unknown sites, assume they might work
                    return true;
                } catch {
                    return true;
                }
            }

            handleExternalUrl(url) {
                const modal = document.createElement('div');
                modal.className = 'external-url-modal';
                modal.innerHTML = `
                    <div class="external-url-content">
                        <h3 style="color: #a0a0ff; margin-bottom: 15px;">üåê External Website Detected</h3>
                        <p style="margin-bottom: 20px; line-height: 1.5;">
                            <strong>${url}</strong><br><br>
                            This website may not work within WebOS due to browser restrictions.
                        </p>
                        <div class="external-url-buttons">
                            <button class="external-url-btn primary" onclick="this.closest('.external-url-modal').remove(); enhancedBrowser.openExternal('${url}')">
                                Open in New Tab
                            </button>
                            <button class="external-url-btn secondary" onclick="this.closest('.external-url-modal').remove(); enhancedBrowser.tryAnyway('${url}')">
                                Try Anyway (May Fail)
                            </button>
                            <button class="external-url-btn secondary" onclick="this.closest('.external-url-modal').remove()">
                                Cancel
                            </button>
                        </div>
                        <div style="margin-top: 20px; font-size: 12px; color: #888; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                            üí° <strong>Tip:</strong> Use "lite" or "mobile" versions of sites for better compatibility
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
            }

            openExternal(url) {
                window.open(url, '_blank', 'noopener,noreferrer');
                showNotification('Browser', 'Opening in new tab...', 2000, 'info');
            }

            tryAnyway(url) {
                const frame = document.getElementById('browser-frame');
                if (!frame) return;
                
                showNotification('Browser', 'Attempting to load site...', 3000, 'info');
                frame.src = url;
                
                // Add to history
                if (this.history[this.currentIndex] !== url) {
                    this.history = this.history.slice(0, this.currentIndex + 1);
                    this.history.push(url);
                    this.currentIndex++;
                }
            }

            goToUrl() {
                const urlBar = document.getElementById('url-bar');
                if (urlBar && urlBar.value) {
                    this.loadUrl(urlBar.value);
                }
            }

            goBack() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    const url = this.history[this.currentIndex];
                    this.loadUrl(url);
                }
            }

            goForward() {
                if (this.currentIndex < this.history.length - 1) {
                    this.currentIndex++;
                    const url = this.history[this.currentIndex];
                    this.loadUrl(url);
                }
            }

            refresh() {
                const frame = document.getElementById('browser-frame');
                if (frame) {
                    frame.src = frame.src;
                    this.isLoading = true;
                    showNotification('Browser', 'Refreshing page...', 1500, 'browser');
                }
            }

            goHome() {
                this.loadUrl(this.homePage);
            }

            updateNavButtons() {
                const backBtn = document.getElementById('back-btn');
                const forwardBtn = document.getElementById('forward-btn');
                
                if (backBtn) {
                    backBtn.disabled = this.currentIndex <= 0;
                }
                if (forwardBtn) {
                    forwardBtn.disabled = this.currentIndex >= this.history.length - 1;
                }
            }

            showLoadingIndicator() {
                const container = document.querySelector('.browser-frame-container');
                if (!container) return;
                
                let indicator = container.querySelector('.proxy-loading');
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.className = 'proxy-loading';
                    indicator.innerHTML = `
                        <div class="proxy-spinner"></div>
                        <div>Loading website...</div>
                    `;
                    container.appendChild(indicator);
                }
                
                setTimeout(() => indicator.remove(), 3000);
            }
        }

        const enhancedBrowser = new EnhancedBrowser();

        // ===== ENHANCED WINAMP PLAYER =====
        class EnhancedWinampPlayer {
            constructor() {
                this.audio = document.getElementById('audio-player');
                this.currentTrack = 0;
                this.isPlaying = false;
                this.volume = 0.7;
                this.playlist = [
                    {
                        title: "Lo-fi Radio Stream",
                        artist: "Chillhop Music",
                        url: "https://stream.laut.fm/chillhop",
                        duration: 0,
                        type: "stream"
                    },
                    {
                        title: "Classical Radio",
                        artist: "BBC Radio 3",
                        url: "https://stream.live.vc.bbcmedia.co.uk/bbc_radio_three",
                        duration: 0,
                        type: "stream"
                    },
                    {
                        title: "Ambient Space",
                        artist: "Space Ambient",
                        url: "https://somafm.com/spacestation130.pls",
                        duration: 0,
                        type: "playlist"
                    }
                ];
                this.visualizerInterval = null;
                this.requiresUserInteraction = false;
                this.audioPermissions = false;
            }

            initialize() {
                this.audio.volume = this.volume;
                this.updatePlaylist();
                this.updateDisplay("Ready to play! Select a track.");
                this.createVisualizer();
                this.updateVolumeDisplay();
                
                // Set up audio events
                this.audio.addEventListener('timeupdate', () => this.updateProgress());
                this.audio.addEventListener('ended', () => this.nextTrack());
                this.audio.addEventListener('error', (e) => {
                    console.error('Audio error:', e);
                    showNotification('Winamp Error', 'Failed to play audio track', 3000, 'error');
                });
                
                // Check audio permissions
                this.checkAudioPermissions();
                
                // Add user interaction requirement overlay
                if (this.requiresUserInteraction) {
                    this.addAudioPermissionOverlay();
                }
                
                // Start visualizer animation
                this.startVisualizer();
            }

            checkAudioPermissions() {
                const testAudio = new Audio();
                testAudio.volume = 0.01;
                
                testAudio.play().then(() => {
                    this.requiresUserInteraction = false;
                    this.audioPermissions = true;
                    testAudio.pause();
                }).catch(() => {
                    this.requiresUserInteraction = true;
                });
            }

            addAudioPermissionOverlay() {
                const player = document.querySelector('.winamp-player');
                if (!player) return;
                
                const overlay = document.createElement('div');
                overlay.className = 'audio-permission';
                overlay.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 20px;">üéµ</div>
                    <h3 style="margin-bottom: 10px;">Audio Permission Required</h3>
                    <p style="margin-bottom: 25px; opacity: 0.8; max-width: 300px;">
                        Your browser requires a click to enable audio playback.
                    </p>
                    <button onclick="enhancedWinamp.enableAudio()" 
                            style="background: linear-gradient(135deg, #667eea, #764ba2); 
                                   border: none; padding: 15px 30px; border-radius: 10px; 
                                   color: white; font-weight: 600; cursor: pointer;">
                        Enable Audio
                    </button>
                `;
                
                player.style.position = 'relative';
                player.appendChild(overlay);
            }

            enableAudio() {
                const unlockAudio = () => {
                    const silentAudio = new Audio();
                    silentAudio.volume = 0.01;
                    
                    silentAudio.play().then(() => {
                        this.audioPermissions = true;
                        this.requiresUserInteraction = false;
                        
                        const overlay = document.querySelector('.audio-permission');
                        if (overlay) overlay.remove();
                        
                        showNotification('Winamp', 'Audio enabled! Ready to play.', 3000, 'success');
                        silentAudio.pause();
                    }).catch(e => {
                        console.error('Failed to unlock audio:', e);
                        showNotification('Winamp', 'Could not enable audio. Try clicking play button.', 4000, 'error');
                    });
                };
                
                unlockAudio();
            }

            updatePlaylist() {
                const container = document.getElementById('winamp-playlist');
                if (!container) return;
                
                container.innerHTML = '';
                
                this.playlist.forEach((track, index) => {
                    const minutes = Math.floor(track.duration / 60);
                    const seconds = track.duration % 60;
                    const durationStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    const item = document.createElement('div');
                    item.className = 'playlist-item' + (index === this.currentTrack ? ' playing' : '');
                    item.innerHTML = `
                        <div>
                            <strong>${index + 1}. ${track.title}</strong><br>
                            <small>${track.artist}</small>
                        </div>
                        <div class="track-duration">${track.duration ? durationStr : 'LIVE'}</div>
                    `;
                    
                    item.onclick = () => this.playTrack(index);
                    
                    container.appendChild(item);
                });
            }

            async playTrack(index) {
                if (this.requiresUserInteraction && !this.audioPermissions) {
                    showNotification('Winamp', 
                        'Please click the "Enable Audio" button first.', 
                        3000, 'warning');
                    return;
                }
                
                if (index < 0 || index >= this.playlist.length) return;
                
                this.currentTrack = index;
                const track = this.playlist[index];
                
                this.audio.src = track.url;
                this.audio.load();
                
                try {
                    await this.audio.play();
                    this.isPlaying = true;
                    document.getElementById('play-btn').textContent = '‚ùö‚ùö';
                    this.updateDisplay(`‚ñ∂ ${track.title} - ${track.artist}`);
                    this.updatePlaylist();
                    this.updateTimeDisplay();
                    showNotification('Winamp', `Now playing: ${track.title}`, 3000, 'winamp');
                } catch (error) {
                    console.error('Playback failed:', error);
                    showNotification('Winamp Error', 
                        'Cannot play track. Click the "Enable Audio" button first.', 
                        4000, 'error');
                }
            }

            togglePlay() {
                if (this.isPlaying) {
                    this.audio.pause();
                    this.isPlaying = false;
                    document.getElementById('play-btn').textContent = '‚ñ∂';
                    this.updateDisplay('‚è∏ Paused');
                } else {
                    if (this.audio.src) {
                        this.audio.play();
                        this.isPlaying = true;
                        document.getElementById('play-btn').textContent = '‚ùö‚ùö';
                        const track = this.playlist[this.currentTrack];
                        this.updateDisplay(`‚ñ∂ ${track.title}`);
                    } else {
                        this.playTrack(0);
                    }
                }
            }

            stop() {
                this.audio.pause();
                this.audio.currentTime = 0;
                this.isPlaying = false;
                document.getElementById('play-btn').textContent = '‚ñ∂';
                this.updateDisplay('‚ñ† Stopped');
                this.updateProgress();
            }

            nextTrack() {
                const nextIndex = (this.currentTrack + 1) % this.playlist.length;
                this.playTrack(nextIndex);
            }

            previousTrack() {
                const prevIndex = this.currentTrack === 0 ? 
                    this.playlist.length - 1 : this.currentTrack - 1;
                this.playTrack(prevIndex);
            }

            setVolume(value) {
                this.volume = value / 100;
                this.audio.volume = this.volume;
                this.updateVolumeDisplay();
                
                if (value == 0) {
                    document.getElementById('mute-btn').textContent = 'üîá';
                } else {
                    document.getElementById('mute-btn').textContent = 'üîä';
                }
            }

            toggleMute() {
                this.audio.muted = !this.audio.muted;
                document.getElementById('mute-btn').textContent = 
                    this.audio.muted ? 'üîá' : 'üîä';
            }

            seek(event) {
                const progressBar = document.getElementById('progress-bar');
                const rect = progressBar.getBoundingClientRect();
                const percent = (event.clientX - rect.left) / rect.width;
                this.audio.currentTime = percent * this.audio.duration;
            }

            updateProgress() {
                const current = this.audio.currentTime;
                const duration = this.audio.duration || 0;
                
                if (duration > 0) {
                    const percent = (current / duration) * 100;
                    document.getElementById('progress-fill').style.width = percent + '%';
                    this.updateTimeDisplay();
                }
            }

            updateTimeDisplay() {
                const current = this.audio.currentTime;
                const duration = this.audio.duration || 0;
                
                const currentMinutes = Math.floor(current / 60);
                const currentSeconds = Math.floor(current % 60);
                const durationMinutes = Math.floor(duration / 60);
                const durationSeconds = Math.floor(duration % 60);
                
                document.getElementById('current-time').textContent = 
                    `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')}`;
                document.getElementById('total-time').textContent = 
                    `${durationMinutes}:${durationSeconds.toString().padStart(2, '0')}`;
                document.getElementById('winamp-time').textContent = 
                    `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')}`;
            }

            updateVolumeDisplay() {
                const volumeText = document.getElementById('volume-text');
                const volumeBadge = document.getElementById('volume-badge');
                const volume = Math.round(this.volume * 100);
                
                if (volumeText) volumeText.textContent = volume + '%';
                if (volumeBadge) volumeBadge.textContent = volume;
            }

            updateDisplay(text) {
                const display = document.getElementById('winamp-display');
                if (display) display.textContent = text;
            }

            createVisualizer() {
                const viz = document.getElementById('visualizer');
                if (!viz) return;
                
                viz.innerHTML = '';
                for (let i = 0; i < 32; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'v-bar';
                    bar.style.height = Math.random() * 100 + '%';
                    viz.appendChild(bar);
                }
            }

            startVisualizer() {
                if (this.visualizerInterval) {
                    clearInterval(this.visualizerInterval);
                }
                
                this.visualizerInterval = setInterval(() => {
                    if (!this.isPlaying) return;
                    
                    const bars = document.querySelectorAll('#visualizer .v-bar');
                    bars.forEach(bar => {
                        const newHeight = Math.random() * 100;
                        bar.style.height = newHeight + '%';
                        const hue = 120 + newHeight * 0.5;
                        bar.style.background = `hsl(${hue}, 100%, 50%)`;
                        bar.style.boxShadow = `0 0 ${Math.random() * 10 + 5}px hsl(${hue}, 100%, 50%)`;
                    });
                }, 100);
            }
        }

        const enhancedWinamp = new EnhancedWinampPlayer();

        // ===== TERMINAL =====
        class Terminal {
            constructor() {
                this.history = [];
                this.historyIndex = -1;
                this.commands = {
                    help: this.showHelp.bind(this),
                    clear: this.clear.bind(this),
                    date: this.showDate.bind(this),
                    time: this.showTime.bind(this),
                    ls: this.listFiles.bind(this),
                    pwd: this.showPath.bind(this),
                    echo: this.echo.bind(this),
                    about: this.showAbout.bind(this),
                    reboot: this.reboot.bind(this),
                    shutdown: this.shutdown.bind(this)
                };
            }

            initialize() {
                this.outputElement = document.getElementById('terminal-output');
                this.inputElement = document.getElementById('terminal-input');
                
                if (this.outputElement && !this.outputElement.innerHTML.trim()) {
                    this.clear();
                    this.printLine('Welcome to WebOS Terminal v2.0');
                    this.printLine('Type "help" for available commands');
                    this.printLine('');
                }
                
                if (this.inputElement) {
                    this.inputElement.focus();
                }
            }

            handleInput(event) {
                if (event.key === 'Enter') {
                    const command = this.inputElement.value.trim();
                    this.inputElement.value = '';
                    
                    if (command) {
                        this.history.push(command);
                        this.historyIndex = this.history.length;
                        this.executeCommand(command);
                    }
                } else if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    if (this.historyIndex > 0) {
                        this.historyIndex--;
                        this.inputElement.value = this.history[this.historyIndex];
                    }
                } else if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    if (this.historyIndex < this.history.length - 1) {
                        this.historyIndex++;
                        this.inputElement.value = this.history[this.historyIndex];
                    } else {
                        this.historyIndex = this.history.length;
                        this.inputElement.value = '';
                    }
                }
            }

            executeCommand(command) {
                this.printLine(`> ${command}`);
                
                const parts = command.split(' ');
                const cmd = parts[0].toLowerCase();
                const args = parts.slice(1);
                
                if (this.commands[cmd]) {
                    this.commands[cmd](args);
                } else {
                    this.printLine(`Command not found: ${cmd}`);
                    this.printLine('Type "help" for available commands');
                }
            }

            showHelp() {
                this.printLine('Available commands:');
                this.printLine('  help        - Show this help message');
                this.printLine('  clear       - Clear terminal screen');
                this.printLine('  date        - Show current date');
                this.printLine('  time        - Show current time');
                this.printLine('  ls          - List files in current directory');
                this.printLine('  pwd         - Print working directory');
                this.printLine('  echo [text] - Echo back text');
                this.printLine('  about       - About WebOS');
                this.printLine('  reboot      - Reboot the system (simulated)');
                this.printLine('  shutdown    - Shutdown the system');
            }

            clear() {
                if (this.outputElement) {
                    this.outputElement.innerHTML = '';
                }
            }

            showDate() {
                const now = new Date();
                this.printLine(now.toDateString());
            }

            showTime() {
                const now = new Date();
                this.printLine(now.toLocaleTimeString());
            }

            listFiles() {
                const files = [
                    'Desktop/',
                    'Documents/',
                    'Downloads/',
                    'Music/',
                    'Pictures/',
                    'notes.txt',
                    'todo.md',
                    'webos_project/'
                ];
                
                files.forEach(file => {
                    this.printLine(file);
                });
            }

            showPath() {
                this.printLine('/home/webos');
            }

            echo(args) {
                this.printLine(args.join(' '));
            }

            showAbout() {
                this.printLine('WebOS v2.0 - A web-based operating system');
                this.printLine('Built with HTML, CSS, and JavaScript');
                this.printLine('Enhanced with browser fixes and local storage');
            }

            reboot() {
                this.printLine('Rebooting system...');
                setTimeout(() => {
                    this.clear();
                    this.printLine('System rebooted successfully!');
                    this.printLine('Welcome back to WebOS Terminal');
                    showNotification('System', 'System rebooted', 3000, 'system');
                }, 1000);
            }

            shutdown() {
                this.printLine('Shutting down system...');
                setTimeout(() => {
                    windowManager.closeWindow('terminal');
                    showNotification('System', 'Terminal session ended', 3000, 'system');
                }, 1000);
            }

            printLine(text) {
                if (this.outputElement) {
                    const line = document.createElement('div');
                    line.className = 'terminal-line';
                    line.textContent = text;
                    this.outputElement.appendChild(line);
                    this.outputElement.scrollTop = this.outputElement.scrollHeight;
                }
            }

            copyOutput() {
                const text = this.outputElement.textContent;
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('Terminal', 'Output copied to clipboard', 2000, 'success');
                });
            }

            reset() {
                this.clear();
                this.initialize();
            }
        }

        const terminal = new Terminal();

        // ===== STORAGE MANAGER =====
        class StorageManager {
            constructor() {
                this.settingsKey = 'webos_v2_settings';
                this.filesKey = 'webos_v2_files';
                this.historyKey = 'webos_v2_history';
            }
            
            saveSettings(settings) {
                try {
                    localStorage.setItem(this.settingsKey, JSON.stringify({
                        ...settings,
                        lastSave: new Date().toISOString()
                    }));
                    return true;
                } catch (e) {
                    console.error('Failed to save settings:', e);
                    return false;
                }
            }
            
            loadSettings() {
                try {
                    const saved = localStorage.getItem(this.settingsKey);
                    return saved ? JSON.parse(saved) : null;
                } catch (e) {
                    console.error('Failed to load settings:', e);
                    return null;
                }
            }
            
            saveWindowPositions(windows) {
                const positions = {};
                Object.keys(windows).forEach(appName => {
                    const element = document.getElementById(`${appName}-window`);
                    if (element) {
                        positions[appName] = {
                            x: parseInt(element.style.left) || 100,
                            y: parseInt(element.style.top) || 100,
                            width: element.offsetWidth,
                            height: element.offsetHeight,
                            maximized: windowManager.maximizedApps.has(appName),
                            minimized: windowManager.minimizedApps.has(appName)
                        };
                    }
                });
                
                localStorage.setItem('webos_window_positions', JSON.stringify(positions));
            }
            
            loadWindowPositions() {
                try {
                    const saved = localStorage.getItem('webos_window_positions');
                    return saved ? JSON.parse(saved) : null;
                } catch (e) {
                    return null;
                }
            }
            
            exportOS() {
                const state = {
                    settings: this.loadSettings(),
                    windows: this.loadWindowPositions(),
                    localFiles: enhancedFileExplorer.localFiles,
                    timestamp: new Date().toISOString(),
                    version: '2.0'
                };
                
                const dataStr = JSON.stringify(state, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportName = `webos_backup_${new Date().toISOString().slice(0,10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportName);
                linkElement.click();
                
                showNotification('System', `Backup exported: ${exportName}`, 4000, 'success');
            }
            
            importOS(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const state = JSON.parse(e.target.result);
                        
                        if (state.version === '2.0') {
                            if (state.settings) {
                                localStorage.setItem(this.settingsKey, JSON.stringify(state.settings));
                            }
                            
                            if (state.windows) {
                                localStorage.setItem('webos_window_positions', JSON.stringify(state.windows));
                            }
                            
                            if (state.localFiles) {
                                localStorage.setItem('webos_local_files', JSON.stringify(state.localFiles));
                                enhancedFileExplorer.localFiles = state.localFiles;
                            }
                            
                            showNotification('System', 'Backup restored successfully! Refresh to apply.', 5000, 'success');
                        } else {
                            showNotification('Import Error', 'Invalid backup file version', 4000, 'error');
                        }
                    } catch (error) {
                        showNotification('Import Error', 'Failed to parse backup file', 4000, 'error');
                    }
                };
                reader.readAsText(file);
            }
        }

        const storageManager = new StorageManager();

        // ===== QUICK LAUNCH =====
        function createQuickLaunch() {
            const quickLaunch = document.createElement('div');
            quickLaunch.className = 'quick-launch';
            quickLaunch.innerHTML = `
                <div class="quick-launch-btn" onclick="openApp('files')" title="File Explorer">üìÅ</div>
                <div class="quick-launch-btn" onclick="openApp('browser')" title="Web Browser">üåê</div>
                <div class="quick-launch-btn" onclick="openApp('winamp')" title="Winamp">üéµ</div>
                <div class="quick-launch-btn" onclick="openApp('terminal')" title="Terminal">üíª</div>
                <div class="quick-launch-btn" onclick="storageManager.exportOS()" title="Export Backup">üíæ</div>
                <div class="quick-launch-btn" onclick="showNotification('Settings', 'Coming soon!')" title="Settings">‚öôÔ∏è</div>
            `;
            
            document.body.appendChild(quickLaunch);
            
            // Make draggable
            let isDragging = false;
            let offset = { x: 0, y: 0 };
            
            quickLaunch.addEventListener('mousedown', (e) => {
                isDragging = true;
                offset.x = e.clientX - quickLaunch.getBoundingClientRect().left;
                offset.y = e.clientY - quickLaunch.getBoundingClientRect().top;
                quickLaunch.style.cursor = 'grabbing';
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const x = e.clientX - offset.x;
                const y = e.clientY - offset.y;
                
                const maxX = window.innerWidth - quickLaunch.offsetWidth - 20;
                const maxY = window.innerHeight - quickLaunch.offsetHeight - 20;
                
                quickLaunch.style.left = Math.max(20, Math.min(x, maxX)) + 'px';
                quickLaunch.style.top = Math.max(20, Math.min(y, maxY)) + 'px';
                quickLaunch.style.right = 'auto';
                quickLaunch.style.transform = 'none';
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
                quickLaunch.style.cursor = 'default';
            });
        }

        // ===== SYSTEM FUNCTIONS =====
        function openApp(appName) {
            windowManager.openApp(appName);
        }

        function closeWindow(appName) {
            windowManager.closeWindow(appName);
        }

        function minimizeWindow(appName) {
            windowManager.minimizeWindow(appName);
        }

        function toggleMaximize(appName) {
            windowManager.toggleMaximize(appName);
        }

        function toggleStartMenu() {
            const menu = document.getElementById('start-menu');
            menu.classList.toggle('active');
        }

        function startDrag(event, appName) {
            windowManager.startDrag(event, appName);
        }

        function enhancedShutdown() {
            // Save everything
            storageManager.saveSettings(WebOS.settings);
            storageManager.saveWindowPositions(windowManager.windows);
            enhancedFileExplorer.saveLocalFiles();
            
            showNotification('System', 'Shutting down WebOS v2.0...', 2000, 'system');
            
            document.body.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #0f0c29 0%, #302b63 100%);
                    height: 100vh;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-family: 'Segoe UI', sans-serif;
                    text-align: center;
                ">
                    <div style="font-size: 72px; margin-bottom: 30px;">üåÄ</div>
                    <h1 style="font-size: 48px; margin-bottom: 20px; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">WebOS v2.0</h1>
                    <p style="font-size: 20px; margin-bottom: 40px; opacity: 0.8;">Enhanced Version - Shutting down...</p>
                    <div style="width: 300px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; margin-bottom: 50px;">
                        <div id="shutdown-progress" style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 3s;"></div>
                    </div>
                    <p style="opacity: 0.6; margin-bottom: 30px;">All settings and files have been saved</p>
                    <button onclick="location.reload()" style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border: none;
                        border-radius: 12px;
                        padding: 15px 40px;
                        color: white;
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s;
                        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
                        margin-top: 20px;
                    ">
                        Restart WebOS
                    </button>
                </div>
            `;
            
            setTimeout(() => {
                const progress = document.getElementById('shutdown-progress');
                if (progress) {
                    progress.style.width = '100%';
                }
            }, 100);
        }

        // ===== CLOCK =====
        function updateClock() {
            const now = new Date();
            const time = now.toLocaleTimeString('en-US', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const date = now.toLocaleDateString('en-US', { 
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });
            
            const clockElement = document.getElementById('clock');
            if (clockElement) {
                clockElement.textContent = `${date} ${time}`;
            }
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ WebOS v2.0 Enhanced Initializing...');
            
            // Register apps
            const apps = ['files', 'browser', 'winamp', 'terminal'];
            apps.forEach(appName => {
                const element = document.getElementById(`${appName}-window`);
                if (element) {
                    windowManager.registerApp(appName, element);
                }
            });
            
            // Set up drag and drop
            document.addEventListener('mousemove', (e) => windowManager.handleDrag(e));
            document.addEventListener('mouseup', () => windowManager.stopDrag());
            
            // Set up clock
            updateClock();
            setInterval(updateClock, 1000);
            
            // Close start menu when clicking outside
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('start-menu');
                const startBtn = document.querySelector('.start-btn');
                
                if (menu && menu.classList.contains('active') && 
                    !menu.contains(e.target) && 
                    !startBtn.contains(e.target)) {
                    menu.classList.remove('active');
                }
            });
            
            // Create quick launch
            createQuickLaunch();
            
            // Auto-save
            window.addEventListener('beforeunload', () => {
                storageManager.saveSettings(WebOS.settings);
                storageManager.saveWindowPositions(windowManager.windows);
                enhancedFileExplorer.saveLocalFiles();
            });
            
            setInterval(() => {
                storageManager.saveSettings(WebOS.settings);
                storageManager.saveWindowPositions(windowManager.windows);
            }, 30000);
            
            // Welcome notification
            setTimeout(() => {
                showNotification(
                    'WebOS v2.0 Enhanced Ready!',
                    'Browser fixes ‚úì Audio permissions ‚úì Local storage ‚úì\nTry entering any URL in the browser!',
                    6000,
                    'success'
                );
            }, 2000);
            
            console.log('‚úÖ WebOS v2.0 Enhanced Ready!');
        });

        // Make everything globally available
        window.openApp = openApp;
        window.closeWindow = closeWindow;
        window.minimizeWindow = minimizeWindow;
        window.toggleMaximize = toggleMaximize;
        window.toggleStartMenu = toggleStartMenu;
        window.startDrag = startDrag;
        window.shutdown = enhancedShutdown;
        window.showNotification = showNotification;
        window.enhancedFileExplorer = enhancedFileExplorer;
        window.enhancedBrowser = enhancedBrowser;
        window.enhancedWinamp = enhancedWinamp;
        window.terminal = terminal;
        window.windowManager = windowManager;
        window.notificationSystem = notificationSystem;
        window.storageManager = storageManager;
        window.WebOS.storage = storageManager;
    </script>
</body>
</html>
